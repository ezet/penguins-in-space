package no.ntnu.tdt4240.asteroids.game.effect;

import com.badlogic.ashley.core.Entity;
import com.badlogic.ashley.core.Family;
import com.badlogic.ashley.core.PooledEngine;
import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.graphics.Texture;
import com.badlogic.gdx.graphics.g2d.TextureRegion;

import no.ntnu.tdt4240.asteroids.entity.component.BulletClass;
import no.ntnu.tdt4240.asteroids.entity.component.DamageComponent;
import no.ntnu.tdt4240.asteroids.entity.component.EffectComponent;
import no.ntnu.tdt4240.asteroids.entity.component.HealthComponent;
import no.ntnu.tdt4240.asteroids.entity.component.ObstacleClass;
import no.ntnu.tdt4240.asteroids.service.Assets;
import no.ntnu.tdt4240.asteroids.service.ServiceLocator;

import static no.ntnu.tdt4240.asteroids.entity.util.ComponentMappers.damageMapper;
import static no.ntnu.tdt4240.asteroids.entity.util.ComponentMappers.healthMapper;


public class InvulnerabilityEffect extends BaseEffect {

    private static final float DEFAULT_DURATION = 5;
    private static final String TAG = InvulnerabilityEffect.class.getSimpleName();
    private DamageComponent damageComponent;
    private HealthComponent healthComponent;
    private Family oldHealthIgnore;

    @Override
    protected void
    applyEffect(PooledEngine engine, Entity entity, EffectComponent effectComponent) {
        damageComponent = damageMapper.get(entity);
        if (damageComponent != null) {
            damageComponent.ignoredEntities = null;
        } else {
            damageComponent = engine.createComponent(DamageComponent.class);
            entity.add(damageComponent);
        }
        healthComponent = healthMapper.get(entity);
        if (healthComponent == null) {
            healthComponent = engine.createComponent(HealthComponent.class);
            entity.add(healthComponent);
        }
        oldHealthIgnore = healthComponent.ignoredEntities;
        healthComponent.ignoredEntities = Family.one(ObstacleClass.class, BulletClass.class).get();
    }

    @Override
    protected void removeEffect(PooledEngine engine, Entity entity, EffectComponent effectComponent) {
        Gdx.app.debug(TAG, "removeEffect: ");
        entity.remove(DamageComponent.class);
        healthComponent.ignoredEntities = oldHealthIgnore;
    }

    @Override
    public float getDuration() {
        return DEFAULT_DURATION;
    }

    @Override
    protected TextureRegion getEffectTexture() {
        return ServiceLocator.getEntityComponent().getEffectTextureFactory().getInvulnerability();
    }

    @Override
    public TextureRegion getPowerupTexture() {
        Texture texture = ServiceLocator.getAppComponent().getAssetLoader().getTexture(Assets.TextureAsset.POWERUP_ARMOR);
        return new TextureRegion(texture);
    }
}
